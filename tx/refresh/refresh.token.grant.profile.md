The specification defines an interoperable OAuth2-based token refresh profile for Dataspace Protocol (DSP) data planes.

## 1. Introduction

When a DSP data transfer is
a [pull transfer](https://docs.internationaldataspaces.org/ids-knowledgebase/v/dataspace-protocol/transfer-process/transfer.process.protocol#id-1.1.2-data-transfer-types),
the requesting data consumer (the client) may receive an access token in the start message that must be presented to the
provider data plane. The DSP specifications do not mandate the type of token presentation required or a refresh
mechanism, as they may vary based on data plane type and transfer format.

This profile defines a token refresh mechanism based on
the [OAuth 2 `refresh_token` grant type.](https://datatracker.ietf.org/doc/html/rfc6749#section-6) Specifically, it
details how a provider authorization server can issue client-constrained refresh tokens and how confidential clients (
dataspace participant agents) must authenticate when presenting a refresh token.

Client authentication is particularly challenging in a dataspace context as a data provider will often not have a
pre-existing relationship with a data consumer. Consequently, using a `client id` and `client secret` is not feasible
for authenticating a token refresh request. This profile defines a mechanism for performing refresh token authentication
based on IATP identities, and, in particular, [Decentralized Identifiers (DIDs.)](https://www.w3.org/TR/did-core/)

## 2. The Refresh Token

When starting a transfer process, an `access_token` may be generated by the provider's data plane authorization server
and returned in the `DataAddress` part of the
DSP [TransferStartMessage](https://docs.internationaldataspaces.org/ids-knowledgebase/v/dataspace-protocol/transfer-process/transfer.process.protocol#id-2.2-transfer-start-message).

This profile adds three additional `EndpointProperties` to the `DataAddress`:

- `refresh_token` - OPTIONAL: An opaque string clients must present when requesting token renewal.
- `expires_in` - REQUIRED if `refresh_token` is present: The lifetime in seconds of the `access_token` as defined by
  the [OAuth 2 specification.](https://datatracker.ietf.org/doc/html/rfc6749#section-4.2.2)
- `refresh_endpoint` - OPTIONAL: The endpoint address for the data plane authorization server that handles token refresh.
  If not present, the data plane endpoint address specified by `dspace:endpoint` in the `DataAddress` will be used.
- `refresh_token_type` - FUTURE USE: reserved for future use.

The following is a non-normative example of a `TransferStartMessage` message containing an `access token`:

```json
{
  "@context": "https://w3id.org/dspace/2024/1/context.json",
  "@type": "dspace:TransferStartMessage",
  "dspace:providerPid": "urn:uuid:a343fcbf-99fc-4ce8-8e9b-148c97605aab",
  "dspace:consumerPid": "urn:uuid:32541fe6-c580-409e-85a8-8a9a32fbe833",
  "dspace:dataAddress": {
    "dspace:endpointType": "https://w3id.org/idsa/v4.1/HTTP",
    "dspace:endpoint": "https://example.com",
    "dspace:endpointProperties": [
      {
        "dspace:name": "access_token",
        "dspace:value": "TOKEN-ABCDEFG"
      },
      {
        "dspace:name": "token_type",
        "dspace:value": "bearer"
      },
      {
        "dspace:name": "refresh_token",
        "dspace:value": "REFRESH-TOKEN-ABCDEFG"
      },
      {
        "dspace:name": "expires_in",
        "dspace:value": "300"
      },
      {
        "dspace:name": "refresh_endpoint",
        "dspace:value": "https://example.com/authorization/refresh"
      }
    ]
  }
}
```

### 2.1 Sender-Constrained Refresh Tokens

The refresh token is an opaque string that SHOULD be constrained to the identity of the client participant agent making
the transfer process start request. When generating a sender-constrained refresh token, the provider MUST bind it to the
requesting participant using the latter's DID-based identity (as defined by
IATP).  [Section 3.2](#3.2-provider-request-validation) defines how refresh token requests are authenticated using a
proof-of-possession scheme.

## 3. The Refresh Request

The client sends refresh token requests to the provider's data plane authorization server endpoint using the OAuth
2 `refresh_token` grant type. A non-normative example is as follows:

```
POST /token HTTP/1.1
Host: server.example.com
Content-Type: application/x-www-form-urlencoded
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c

grant_type=refresh_token&refresh_token=dFds4UOlH1QP7Fj3OkOAxM
```
Response:
```
HTTP 200 OK
Content-Type: application/json;charset=UTF-8

{
  "access_token": "TOKEN-ABCDEFG",
  "token_type": "bearer",
  "refresh_token": "REFRESH-TOKEN-ABCDEFG",
  "refresh_endpoint": "https://example.com/authorization/refresh",
  "expires_in": "300"  
}
```


### 3.1. Client Authentication

The client making a refresh token request MUST use the bearer tokens as defined
in [RFC6750.](https://datatracker.ietf.org/doc/html/rfc6750). The client identifier is a JWT conforming to the
following specifications:

- The `kid` header parameter references the key material that is contained in the client's `DID Document` that can be
  used to verify the JWT.
- The `iss` claim is set to the client's `DID`.
- The `sub` claim is set to the client's `DID`.
- A `access_token` contains the access token associated with the refresh token.
- The JWT is signed using the private key associated with the key material specified by the `kid` header parameter.

### 3.2. Provider Request Validation

The provider data plane authorization server can verify the refresh request using the signed client JWT following these
steps:

- Resolve the client's `DID Document` using the `iss` claim.
- Resolve the public key specified by the `kid` header parameter in the `DID Document`.
- Verify the JWT using the resolved public key.
- Compare the client's `DID` to the `DID` the refresh token is bound to.

Provider data plane authorization servers SHOULD implement the additional recommendations outlined
in [OAuth 2.0 Security Best Current Practice](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics#section-4.14)

### 3.3. The Refresh Response

If validated and authorized, the provider data plane authorization server issues an access token as described in
the [OAuth 2 specification](https://datatracker.ietf.org/doc/html/rfc6749#section-5.1). Note that the authorization server may issue a new refresh token.

